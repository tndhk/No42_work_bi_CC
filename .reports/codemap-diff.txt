==============================================================================
コードマップ差分レポート
生成日時: 2026-02-05
トリガー: Audit Log 機能追加 (監査ログテーブル + AuditService + 既存ルート統合 + Frontend UI)
==============================================================================

状態: 既存コードマップからの更新 (前回: 2026-02-04 FR-2.1 Transform基盤)

------------------------------------------------------------------------------
変更概要
------------------------------------------------------------------------------

今回の更新トリガー:
- Audit Log 機能: DynamoDB テーブル (bi_audit_logs), Model, Repository, Service, Route
- AuditService を既存ルートに統合 (auth, cards, datasets, dashboard_shares, transforms)
- Frontend: AuditLogListPage, use-audit-logs hook, audit-logs API, audit-log types
- Sidebar: admin 向け監査ログリンク追加 (ScrollText アイコン)
- ルーティング: /admin/audit-logs 追加
- DynamoDB テーブル 10 -> 11 (bi_audit_logs 追加, GSI: LogsByUser, LogsByTarget)
- init_tables.py: bi_audit_logs テーブル定義追加

------------------------------------------------------------------------------
ファイルごとの差分率
------------------------------------------------------------------------------

                       旧行数   新行数   差分行数   差分率    判定
architecture.md          500      542      +42      8.4%    AUTO UPDATE
backend.md               797      858      +61      7.7%    AUTO UPDATE
data.md                  807      877      +70      8.7%    AUTO UPDATE
frontend.md              649      668      +19      2.9%    AUTO UPDATE
------------------------------------------------------------------------------
合計                    2753     2945     +192      7.0%    AUTO UPDATE

全体差分率: 7.0% (閾値 30% 以下 --> 自動更新)

------------------------------------------------------------------------------
architecture.md の変更内容 (+42, 8.4%)
------------------------------------------------------------------------------

[UPDATED] 最終更新タイムスタンプ (Audit Log 機能追加)
[UPDATED] システム構成図: DynamoDB 10->11テーブル、[AuditService] 追記
[NEW]     /api/audit-logs 通信パターン追加 (admin専用)
[NEW]     各ルートから AuditLog への通信を明示 ([AuditLog] 注記)
[UPDATED] 認証フロー: AuditService.log_user_login/log_user_login_failed 追加
[UPDATED] 認可レイヤー: require_admin 適用先に /api/audit-logs 追加
[NEW]     監査ログ (Audit Log) セクション追加 (EventType 12種, 呼び出し元一覧)
[UPDATED] DynamoDBテーブル: bi_audit_logs (GSI: LogsByUser, LogsByTarget) 追加
[UPDATED] リポジトリ一覧: 10->11 (AuditLogRepository 追加)
[UPDATED] サービス一覧: 11->12 (AuditService 追加)
[UPDATED] APIルーター一覧: /api/audit-logs 追加
[UPDATED] フロントエンド ルーティング: /admin/audit-logs 追加
[UPDATED] データフロー各セクションに AuditService 呼び出しを追記

------------------------------------------------------------------------------
backend.md の変更内容 (+61, 7.7%)
------------------------------------------------------------------------------

[UPDATED] 最終更新タイムスタンプ (Audit Log 機能追加)
[NEW]     ディレクトリ構造: audit_logs.py, audit_log.py, audit_log_repository.py, audit_service.py 追加
[NEW]     API routes: audit_logs エンドポイント (admin専用, フィルタ付き一覧)
[NEW]     モデル: AuditLog, EventType (12種類の監査イベント)
[NEW]     リポジトリ: AuditLogRepository (複合キー, GSI: LogsByUser, LogsByTarget)
[NEW]     サービス: AuditService (fire-and-forget パターン)
[UPDATED] 依存関係グラフ: audit_logs.py ルート追加
[UPDATED] auth.py, cards.py, datasets.py, dashboard_shares.py 依存に audit_service.py 追加
[UPDATED] DynamoDBテーブル一覧: bi_audit_logs 追加
[UPDATED] テスト一覧: audit_log 関連テスト3ファイル追加 (model, repository, service)
[UPDATED] routes テスト: test_audit_logs.py 追加

------------------------------------------------------------------------------
data.md の変更内容 (+70, 8.7%)
------------------------------------------------------------------------------

[UPDATED] 最終更新タイムスタンプ (Audit Log 機能追加)
[UPDATED] テーブル総数: 10 -> 11
[NEW]     DynamoDBテーブル一覧: bi_audit_logs 追加 (GSI: LogsByUser, LogsByTarget)
[NEW]     スキーマ詳細: bi_audit_logs 全属性 + クエリパターン
[NEW]     Pydanticモデル: audit_log.py (EventType, AuditLog)
[NEW]     TypeScript型: audit-log.ts (EventType, AuditLog, AuditLogListParams)
[UPDATED] エンティティ関係図: mermaid/ASCII に AuditLog エンティティ追加

------------------------------------------------------------------------------
frontend.md の変更内容 (+19, 2.9%)
------------------------------------------------------------------------------

[UPDATED] 最終更新タイムスタンプ (Audit Log 機能追加)
[NEW]     ページ: AuditLogListPage.tsx (admin専用, フィルタ+ページネーション)
[NEW]     Hooks: use-audit-logs.ts (useAuditLogs query)
[NEW]     API: audit-logs.ts (auditLogsApi.list)
[NEW]     型定義: audit-log.ts (EventType, AuditLog, AuditLogListParams)
[UPDATED] ルーティング: /admin/audit-logs 追加
[UPDATED] Sidebar: admin 向け監査ログリンク追加 (ScrollText アイコン)
[UPDATED] React Query キー: ['audit-logs', params?] 追加
[UPDATED] API モジュール数: 8->9
[UPDATED] 型定義一覧テーブル: audit-log.ts 追加

------------------------------------------------------------------------------
スキャン統計 (更新後)
------------------------------------------------------------------------------

Backend (app/):
  ソースファイル:      ~55 (.py)  [前回: ~50 -> Audit Log関連4ファイル追加]
  テストファイル:      56 (.py)   [前回: 52 -> Audit Log関連テスト4ファイル追加]
  ルートモジュール:    11         [前回: 10 -> audit_logs.py 追加]
  モデルモジュール:    12         [前回: 12 -> audit_log.py 既存ファイル追加, 総数不変]
  リポジトリ:         11         [前回: 10 -> audit_log_repository.py 追加]
  サービス:           12         [前回: 11 -> audit_service.py 追加]

Frontend (src/):
  テストファイル:      64 (.ts/.tsx)  [変更なし]
  ページ:             12             [前回: 11 -> AuditLogListPage 追加]
  コンポーネント:     ~30            [変更なし]
  Hooks:               9 ファイル    [前回: 8 -> use-audit-logs.ts 追加]
  API クライアント:    9             [前回: 8 -> audit-logs.ts 追加]
  型定義:             10 ファイル    [前回: 9 -> audit-log.ts 追加]

DynamoDB:
  テーブル数:         11             [前回: 10 -> bi_audit_logs 追加]

------------------------------------------------------------------------------
AuditService 統合マトリクス (新規)
------------------------------------------------------------------------------

| ルートファイル | 対象イベント | 呼び出しタイミング |
|---------------|------------|-------------------|
| auth.py | USER_LOGIN | ログイン成功後 |
| auth.py | USER_LOGOUT | ログアウト後 |
| auth.py | USER_LOGIN_FAILED | 認証失敗時 (user_not_found, invalid_password) |
| cards.py | CARD_EXECUTION_FAILED | preview/execute 失敗時 (RuntimeError) |
| datasets.py | DATASET_CREATED | CSV インポート成功後 |
| datasets.py | DATASET_IMPORTED | S3インポート/再取り込み成功後 |
| datasets.py | DATASET_DELETED | データセット削除後 |
| dashboard_shares.py | DASHBOARD_SHARE_ADDED | 共有作成後 |
| dashboard_shares.py | DASHBOARD_SHARE_REMOVED | 共有削除後 |
| dashboard_shares.py | DASHBOARD_SHARE_UPDATED | 共有権限更新後 |
| transforms.py | TRANSFORM_EXECUTED | Transform 実行成功後 |
| transforms.py | TRANSFORM_FAILED | Transform 実行失敗時 (RuntimeError) |

------------------------------------------------------------------------------
注意事項 (更新)
------------------------------------------------------------------------------

[継続] Executor の dataset_rows は将来拡張用で、現在 None 固定
[継続] Frontend の types には OwnerRef, GroupRef 等 Backend 側に対応モデルが無い型がある
[継続] Backend の一覧ページネーションは全件取得後 Python スライスで実装。
       大量データ時はパフォーマンス懸念あり。
[継続] E2E テストは workers:1 (シングルスレッド) で実行。
[継続] TransformExecutionRepository は複合キー (PK: transformId, SK: startedAt) を使用。
[継続] スケジューラは asyncio バックグラウンドタスクとして main.py の lifespan で起動。

[NEW]  AuditService は fire-and-forget パターン。全例外を握りつぶすため、監査ログの
       書き込み失敗がビジネスロジックに影響しない設計。
[NEW]  AuditLogRepository は list_all で user_id/target_id 指定時に GSI ベースの
       Query を使用し、それ以外は Scan + FilterExpression にフォールバック。
       大量ログ時は Scan のパフォーマンスに注意。
[NEW]  USER_LOGIN_FAILED イベントでは user_id が "unknown" に設定される
       (DynamoDB GSI キーは空文字不可のため)。target_id にはメールアドレスが格納される。

==============================================================================
