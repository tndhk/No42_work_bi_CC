==============================================================================
コードマップ差分レポート
生成日時: 2026-02-01
トリガー: Phase Q4 (E2E テスト) + Phase Q5 (クリーンアップ) 完了
==============================================================================

状態: 既存コードマップからの更新 (前回: 2026-01-31 Phase Q3 完了後)

------------------------------------------------------------------------------
変更概要
------------------------------------------------------------------------------

今回の更新トリガー:
- backend/app/api/response.py 追加 (APIレスポンス標準化)
- backend/app/api/routes/*.py 更新 (api_response/paginated_response ラップ、clone追加)
- frontend/e2e/ ディレクトリ追加 (Playwright E2E テスト 3スペック, 12テスト)
- frontend/playwright.config.ts 追加
- scripts/seed_test_user.py 追加 (E2E テスト用ユーザSeed)
- docker-compose.yml 更新 (全サービスにヘルスチェック追加)
- package.json 更新 (@playwright/test 追加、e2e スクリプト追加)

------------------------------------------------------------------------------
ファイルごとの差分率
------------------------------------------------------------------------------

                       旧行数   新行数   差分行数   差分率    判定
architecture.md          211      263      +52     24.6%    AUTO UPDATE
backend.md               236      284      +48     20.3%    AUTO UPDATE
frontend.md              375      426      +51     13.6%    AUTO UPDATE
data.md                  402      430      +28      7.0%    AUTO UPDATE
------------------------------------------------------------------------------
合計                    1224     1403     +179     14.6%    AUTO UPDATE

全体差分率: 14.6% (閾値 30% 未満 --> 自動更新承認)

------------------------------------------------------------------------------
architecture.md の変更内容 (+52行, 24.6%)
------------------------------------------------------------------------------

[UPDATED] 最終更新タイムスタンプ (Phase Q4 E2E + Q5 クリーンアップ 注記)
[UPDATED] サービス一覧テーブル -- ヘルスチェック列追加
[NEW]     docker-compose サービス起動順序 セクション
          (healthcheck + depends_on: condition: service_healthy の説明)
[UPDATED] ディレクトリ構造 -- api/ 記述に "レスポンスヘルパー" 追加
[UPDATED] ディレクトリ構造 -- tests/ ファイル数更新 (29 -> 37)
[NEW]     ディレクトリ構造 -- e2e/ ディレクトリ記述追加
[NEW]     ディレクトリ構造 -- playwright.config.ts 記述追加
[NEW]     ディレクトリ構造 -- scripts/seed_test_user.py 記述追加
[UPDATED] サービス間通信 -- clone ルート追加
[UPDATED] 認証フロー -- api_response() ラップ記述追加
[UPDATED] データフロー: CSV インポート -- api_response() ステップ追加
[UPDATED] データフロー: カード実行 -- api_response() ステップ追加
[NEW]     APIレスポンス標準化 セクション (api_response, paginated_response 説明)
[UPDATED] Frontend テストライブラリ -- @playwright/test 1.58.1 追加
[UPDATED] テストインフラストラクチャ -- E2E 行追加、Backend ファイル数修正
[NEW]     E2E テスト構成 セクション (ディレクトリ構造 + Playwright 設定説明)

------------------------------------------------------------------------------
backend.md の変更内容 (+48行, 20.3%)
------------------------------------------------------------------------------

[UPDATED] 最終更新タイムスタンプ (Phase Q4 E2E + Q5 クリーンアップ 注記)
[NEW]     ディレクトリ構造 -- response.py [NEW] 記述追加
[UPDATED] ディレクトリ構造 -- routes/*.py に [UPDATED] タグ (api_response/paginated)
[UPDATED] ディレクトリ構造 -- tests/ ファイル数更新 (29 -> 37)
[NEW]     APIレスポンスヘルパー セクション (api_response, paginated_response)
[UPDATED] API ルートテーブル -- レスポンス形式列追加 (api_response/paginated_response)
[NEW]     API ルートテーブル -- POST /dashboards/:id/clone 追加
[NEW]     ページネーション仕様 セクション (limit/offset パラメータ)
[UPDATED] 依存関係グラフ -- 全 routes に api/response.py への依存追加
[NEW]     ダッシュボードクローン セクション (clone フロー説明)
[NEW]     ルート内ヘルパー関数 テーブル (_check_owner_permission)

------------------------------------------------------------------------------
frontend.md の変更内容 (+51行, 13.6%)
------------------------------------------------------------------------------

[UPDATED] 最終更新タイムスタンプ (Phase Q4 E2E + Q5 クリーンアップ 注記)
[UPDATED] ヘッダー テストカバレッジ -- E2E 統計追加
[NEW]     ディレクトリ構造 -- playwright.config.ts 記述
[NEW]     ディレクトリ構造 -- e2e/ 全ファイル記述 (6ファイル + 2サブディレクトリ)
[NEW]     E2E テスト (Playwright) セクション:
          - 構成テーブル (3スペック, 12テスト)
          - テストヘルパーテーブル (7関数)
          - テストデータ管理 (テストユーザ、beforeEach/afterEach パターン)
          - Playwright 設定詳細
[UPDATED] テストインフラストラクチャ --> "ユニットテストインフラストラクチャ" にリネーム

------------------------------------------------------------------------------
data.md の変更内容 (+28行, 7.0%)
------------------------------------------------------------------------------

[UPDATED] 最終更新タイムスタンプ (Phase Q4 E2E + Q5 クリーンアップ 注記)
[NEW]     APIレスポンスヘルパー (Backend) セクション
          (api_response, paginated_response のコードとFrontend型との対応)
[UPDATED] エンティティ関係図 -- clone --> new Dashboard 追加
[NEW]     Backend <--> Frontend レスポンスマッピング テーブル
          (api_response -> ApiResponse, paginated_response -> PaginatedResponse,
           HTTPException -> ApiErrorResponse)

------------------------------------------------------------------------------
スキャン統計 (更新後)
------------------------------------------------------------------------------

Backend (app/):
  ソースファイル:      37 (.py)  [前回: 36 --> +1 (response.py)]
  テストファイル:      37 (.py)  [前回: 29 --> +8 (routes テスト追加)]
  ルートモジュール:     4       [変更なし]
  モデルモジュール:     5       [変更なし]
  リポジトリ:          5       [変更なし]
  サービス:            6       [変更なし]
  コアモジュール:      4       [変更なし]
  DB接続:              2       [変更なし]
  APIヘルパー:         1       [NEW: response.py]

Frontend (src/):
  ソースファイル:     100 (.ts/.tsx)  [前回: 100 (含テスト) --> 変更なし]
  実質ソースファイル:  60 (非テスト)  [変更なし]
  テストファイル:      40 (.ts/.tsx)  [前回: 37 --> +3 (vitest.d.ts等カウント差)]
  テスト数:          227             [変更なし (Unit)]
  カバレッジ:       83.07%           [変更なし]
  ページ:              9             [変更なし]
  コンポーネント:     19             [変更なし]
  Hooks:               4 ファイル --> 20 export   [変更なし]
  API クライアント:    5             [変更なし]
  型定義:              5 ファイル    [変更なし]
  ストア:              1             [変更なし]

Frontend (e2e/) [NEW]:
  E2E テストファイル:   6 (.ts)
    - 3 spec ファイル (auth, dataset, card-dashboard)
    - 1 global-setup.ts
    - 2 helper ファイル (login-helper, api-helper)
  テスト数:           12
  サンプルデータ:      1 (test-sales.csv)

Scripts:
  スクリプトファイル:   2 (.py)  [前回: 1 --> +1 (seed_test_user.py)]

Executor (app/):
  ソースファイル:       7 (.py)  [変更なし]
  テストファイル:       7         [変更なし]

Docs:
  9 ドキュメント       [変更なし]

------------------------------------------------------------------------------
新規ファイル一覧
------------------------------------------------------------------------------

Backend:
  + backend/app/api/response.py           (api_response, paginated_response)

Frontend:
  + frontend/playwright.config.ts          (E2E テスト設定)
  + frontend/e2e/global-setup.ts           (バックエンド起動待機)
  + frontend/e2e/auth.spec.ts              (認証 E2E テスト)
  + frontend/e2e/dataset.spec.ts           (データセット E2E テスト)
  + frontend/e2e/card-dashboard.spec.ts    (カード+ダッシュボード E2E テスト)
  + frontend/e2e/helpers/login-helper.ts   (UI ログインヘルパー)
  + frontend/e2e/helpers/api-helper.ts     (テストデータ CRUD ヘルパー)
  + frontend/e2e/sample-data/test-sales.csv (サンプル CSV)

Scripts:
  + scripts/seed_test_user.py              (E2E テストユーザ作成)

------------------------------------------------------------------------------
変更ファイル一覧
------------------------------------------------------------------------------

Backend:
  ~ backend/app/api/routes/auth.py         (api_response ラップ適用)
  ~ backend/app/api/routes/cards.py        (api_response/paginated_response, ページネーション)
  ~ backend/app/api/routes/dashboards.py   (api_response/paginated_response, clone 追加)
  ~ backend/app/api/routes/datasets.py     (api_response/paginated_response, ページネーション)

Infrastructure:
  ~ docker-compose.yml                     (全サービス healthcheck 追加)
  ~ frontend/package.json                  (@playwright/test 追加, e2e スクリプト追加)

------------------------------------------------------------------------------
検出された構造パターン (更新)
------------------------------------------------------------------------------

1-7: [変更なし -- 前回レポート参照]

8. APIレスポンス標準化パターン [NEW]
   全ルートハンドラが api/response.py のヘルパー関数を使用して
   レスポンスをラップ。Frontend の ApiResponse<T> / PaginatedResponse<T>
   型と構造的に整合。ラッパー不一致の問題は解消済み。

9. サーバサイドページネーションパターン [NEW]
   一覧 API (datasets, cards, dashboards) が limit/offset クエリパラメータ
   を受け付け、paginated_response() で { data, pagination } 形式を返却。
   全リポジトリの list_by_owner() で全件取得後、Python 側でスライスする
   アプリケーションレベルページネーション。

10. ダッシュボードクローンパターン [NEW]
    POST /dashboards/:id/clone でソースダッシュボードの layout/filters を
    コピーし、新しい owner_id とサフィックス名で新規作成。

11. E2E テストパターン [NEW]
    Playwright + global-setup (ヘルスチェック) + helpers (loginViaUI, API direct)。
    beforeEach で UI ログイン、afterEach で API 経由のデータクリーンアップ。
    テストデータは逆依存順 (Dashboard -> Card -> Dataset) で削除。

12. テストユーザSeedパターン [NEW]
    scripts/seed_test_user.py で DynamoDB Local に冪等にテストユーザを挿入。
    E2E テストの前提条件として使用。

------------------------------------------------------------------------------
注意事項 (更新)
------------------------------------------------------------------------------

[継続] Executor の dataset_rows は将来拡張用で、現在 None 固定
[継続] Frontend の types には OwnerRef, GroupRef 等 Backend 側に対応モデルが無い型がある

[解消] dashboardsApi.clone() は Backend 側に対応ルートが無い (未実装)
       --> POST /api/dashboards/:id/clone が実装された

[解消] Frontend の lib/api/auth.ts は ApiResponse<T> ラッパーを期待するが、
       Backend は直接モデルを返している (ラッパー不一致の可能性)
       --> 全ルートが api_response() でラップされ、整合性が確保された

[継続] DashboardEditor/DashboardViewer は react-grid-layout の Responsive +
       WidthProvider を使用。CSS は __tests__/setup.ts でモック化されている。
[継続] layout-utils.ts は pure function のみで副作用なし。テストカバー済み。

[NEW]  Backend の一覧ページネーションは全件取得後 Python スライスで実装。
       大量データ時はパフォーマンス懸念あり。DynamoDB の LastEvaluatedKey
       ベースのページネーションへの移行を検討。

[NEW]  E2E テストは workers:1 (シングルスレッド) で実行。DynamoDB Local が
       共有データベースのため、並列実行時にテスト間干渉の可能性あり。

==============================================================================
